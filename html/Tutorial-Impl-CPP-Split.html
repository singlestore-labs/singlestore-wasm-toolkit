<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>For the split-str Example - SingleStore Wasm Toolkit</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Tutorial-Overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="Tutorial-Setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Setup-Container.html"><strong aria-hidden="true">2.1.</strong> With a Development Container</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Setup-Container-VSCode.html"><strong aria-hidden="true">2.1.1.</strong> VS Code Container</a></li><li class="chapter-item expanded "><a href="Tutorial-Setup-Container-Standalone.html"><strong aria-hidden="true">2.1.2.</strong> Standalone Container</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Setup-Local.html"><strong aria-hidden="true">2.2.</strong> Locally</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li class="chapter-item expanded "><a href="Tutorial-WIT.html"><strong aria-hidden="true">4.</strong> Writing WIT IDL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-WIT-Power.html"><strong aria-hidden="true">4.1.</strong> WIT for the power-of Example</a></li><li class="chapter-item expanded "><a href="Tutorial-WIT-Split.html"><strong aria-hidden="true">4.2.</strong> WIT for the split-str Example</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Impl.html"><strong aria-hidden="true">5.</strong> Implementation and Compilation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Impl-CPP.html"><strong aria-hidden="true">5.1.</strong> Using C/C++</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Impl-CPP-Power.html"><strong aria-hidden="true">5.1.1.</strong> For the power-of Example</a></li><li class="chapter-item expanded "><a href="Tutorial-Impl-CPP-Split.html" class="active"><strong aria-hidden="true">5.1.2.</strong> For the split-str Example</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Impl-Rust.html"><strong aria-hidden="true">5.2.</strong> Using Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Impl-Rust-Power.html"><strong aria-hidden="true">5.2.1.</strong> For the power-of Example</a></li><li class="chapter-item expanded "><a href="Tutorial-Impl-Rust-Split.html"><strong aria-hidden="true">5.2.2.</strong> For the split-str Example</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Test.html"><strong aria-hidden="true">6.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Test-Power.html"><strong aria-hidden="true">6.1.</strong> Testing the power-of Example</a></li><li class="chapter-item expanded "><a href="Tutorial-Test-Split.html"><strong aria-hidden="true">6.2.</strong> Testing the split-str Example</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Deploy.html"><strong aria-hidden="true">7.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Deploy-Power.html"><strong aria-hidden="true">7.1.</strong> Deploying the power-of Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Deploy-Power-Push.html"><strong aria-hidden="true">7.1.1.</strong> Using pushwasm</a></li><li class="chapter-item expanded "><a href="Tutorial-Deploy-Power-Cloud.html"><strong aria-hidden="true">7.1.2.</strong> From Cloud Storage</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Deploy-Split.html"><strong aria-hidden="true">7.2.</strong> Deploying the split-str Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Deploy-Split-Push.html"><strong aria-hidden="true">7.2.1.</strong> Using pushwasm</a></li><li class="chapter-item expanded "><a href="Tutorial-Deploy-Split-Cloud.html"><strong aria-hidden="true">7.2.2.</strong> From Cloud Storage</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-Running.html"><strong aria-hidden="true">8.</strong> Running In the Database</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Tutorial-Running-Power.html"><strong aria-hidden="true">8.1.</strong> Running the power_of UDF</a></li><li class="chapter-item expanded "><a href="Tutorial-Running-Split.html"><strong aria-hidden="true">8.2.</strong> Running the split_str TVF</a></li></ol></li><li class="chapter-item expanded "><a href="Tutorial-WrapUp.html"><strong aria-hidden="true">9.</strong> Wrap-Up</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SingleStore Wasm Toolkit</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementing-the-split-str-example-in-c"><a class="header" href="#implementing-the-split-str-example-in-c">Implementing the <code>split-str</code> example in C++</a></h1>
<h2 id="generating-bindings"><a class="header" href="#generating-bindings">Generating Bindings</a></h2>
<p>In this example, we’ll use C++ so that we can leverage the STL’s higher-level data structures and keep our implementation focused on the big picture as much as possible.</p>
<p>As before, we’ll start by generating the C language bindings. Run the <em>wit-bindgen</em> command:</p>
<pre><code class="language-bash">wit-bindgen c --export split.wit
</code></pre>
<p>There should now be a <code>split.c</code> and <code>split.h</code> file in your work directory. Since we’ll be using C++, rename <code>split.c</code> to <code>split.cpp</code>:</p>
<h2 id="implementing-and-compiling"><a class="header" href="#implementing-and-compiling">Implementing and Compiling</a></h2>
<p>Since we’ll be using C++, rename <code>split.c</code> to <code>split.cpp</code>:</p>
<pre><code class="language-bash">mv split.c split.cpp
</code></pre>
<p>Now let’s take a look at <code>split.h</code>. As we might expect, there are a few more definitions in here than in the simpler <code>power-of</code> example. The wit-bindgen program has generated a struct definition for us to use when passing our strings, as well as ones for the subphrase record and its enclosing list. At the bottom is prototype for the function we are going to implement:</p>
<pre><code class="language-cpp">void split_split_str(split_string_t *phrase, split_string_t *delim, split_list_subphrase_t *ret0);
</code></pre>
<p>This, too, looks a bit different than in the <code>power-of</code> example. For one thing, the function doesn’t return a value. Since this function will be returning a list, for which we’ll need to dynamically allocate memory, the result is passed as an argument pointer instead.</p>
<p>Now let’s open up the <code>split.cpp</code> file. Once again, we are going to add our implementation here. At the bottom of the file, we can find the generated wrapper function, called <code>__wasm_export_split_split_str</code>. This wrapper delegates to the function we will be implementing, and we also can see that it is doing work required for lifting and lowering the data types on either side of the function call.</p>
<p>We’ll now add our code. Let’s first update the top of <code>split.cpp</code> as follows:</p>
<pre><code class="language-cpp">#include &lt;memory&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;string&gt;
#include &lt;vector&gt;
#include &lt;split.h&gt;
</code></pre>
<p>Since C++ has a more strict compiler than C, we’ll also need to make a small change to the generated code in this file at line 38. Go ahead and change the following line:</p>
<pre><code class="language-cpp">ret-&gt;ptr = canonical_abi_realloc(NULL, 0, 1, ret-&gt;len);
</code></pre>
<p>... to this:</p>
<pre><code>ret-&gt;ptr = reinterpret_cast&lt;char *&gt;(canonical_abi_realloc(NULL, 0, 1, ret-&gt;len));
</code></pre>
<p>And finally, to the bottom of the file, we’ll add this chunk of code:</p>
<pre><code class="language-cpp">void split_split_str(split_string_t *phrase, split_string_t *delim, split_list_subphrase_t *ret0)
{
    // Clear the result.
    memset(ret0, 0, sizeof(split_list_subphrase_t));

    // Parse the tokens.
    std::string phr(phrase-&gt;ptr, phrase-&gt;len);
    std::string dlm(delim-&gt;ptr, delim-&gt;len);
    std::string tok;
    std::vector&lt;std::pair&lt;std::string, size_t&gt;&gt; subs;
    size_t start = 0, end = 0;
    if (delim-&gt;len)
    {
        while ((end = phr.find(dlm, start)) != std::string::npos)
        {
            tok = phr.substr(start, end - start);
            subs.push_back(std::pair&lt;std::string, size_t&gt;(tok, start));
            start = end + dlm.length();
        }
    }
    subs.push_back(std::pair&lt;std::string, size_t&gt;(phr.substr(start), start));

    // Populate the result.
    bool err = false;
    auto res = (split_subphrase_t *) malloc(phr.size() * sizeof(split_subphrase_t));
    for (int i = 0; !err &amp;&amp; i &lt; subs.size(); ++i)
    {
        auto&amp; sub = subs[i].first;
        res[i].idx = static_cast&lt;int32_t&gt;(subs[i].second);
        res[i].str.len = sub.length();
        res[i].str.ptr = strdup(sub.c_str());
        if (!res[i].str.ptr)
            err = true;
    }

    // If success, assign the result. Else, clean up and return an empty list.
    if (!err)
    {
        // Success; assign the result.
        ret0-&gt;ptr = res;
        ret0-&gt;len = subs.size();
    }
    else
    {
        if (res)
        {
            for (int i = 0; i &lt; subs.size(); ++i)
                if (res[i].str.ptr)
                    free(res[i].str.ptr);
            free(res);
        }
    }

    // Per the Canonical ABI contract, free the input pointers.
    free(phrase-&gt;ptr);
    free(delim-&gt;ptr);
}
</code></pre>
<p>There is much more work going on here than in the <a href="Tutorial-Impl-CPP-Power.html"><code>power-of</code></a> example; a fair amount of it deals with memory management.</p>
<p>The Wasm Canonical ABI requires that any dynamic memory passed from the host to the guest or vice-versa transfers the ownership to the receiver. This explains the last two lines of our <code>split_split_str</code> function, where we free the pointers to the strings we have been passed as arguments. This memory will have been allocated by the host using our guest module’s exported <code>canonical_abi_realloc</code> function, which takes it from the Wasm instance’s linear memory at runtime. Conversely, you may also notice that we pass dynamically allocated memory out of the function; the host is expected to free it by calling our module's <code>canonical_abi_free</code> routine, which will return it to the linear memory.</p>
<p>Now let’s save the file and build the module. We will use a similar approach as we did in the simple example above, but with a couple of tweaks. First, we’ll use clang++, since this is C++ code. And second, we’ll need to include the option <code>-fno-exceptions</code> because Wasm doesn’t yet support exception handling (there is a proposal, however).</p>
<pre><code class="language-bash">clang++                          \
    -fno-exceptions              \
    --target=wasm32-unknown-wasi \
    -mexec-model=reactor         \
    -s                           \
    -I.                          \
    -o split.wasm                \
    split.cpp
</code></pre>
<p>As expected, there should now be a <code>split.wasm</code> file in your work directory.</p>
<p>Next, we'll do some <a href="Tutorial-Test-Split.html">testing</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Tutorial-Impl-CPP-Power.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="Tutorial-Impl-Rust.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Tutorial-Impl-CPP-Power.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="Tutorial-Impl-Rust.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
